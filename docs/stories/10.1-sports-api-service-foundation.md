# Story 10.1: Sports API Service Foundation

**Status:** Ready for Review  
**Epic:** 10 - Sports API Integration  
**Story Points:** 8  
**Priority:** Critical  
**Dependencies:** None

---

## Story

**As a** system architect,  
**I want** a foundational sports-api service structure with base components,  
**so that** we can build NFL and NHL API integrations on a solid, well-configured foundation.

---

## Acceptance Criteria

1. ‚úÖ Sports API service directory structure created following `docs/architecture/source-tree.md`
2. ‚úÖ Base `APISportsClient` class implemented with aiohttp session management
3. ‚úÖ Docker Compose service definition added for sports-api
4. ‚úÖ Environment variable configuration template created
5. ‚úÖ Health check endpoint `/health` returns service status
6. ‚úÖ Shared logging integration configured
7. ‚úÖ Service starts successfully in Docker Compose
8. ‚úÖ Unit tests for base client with 90%+ coverage
9. ‚úÖ Service accessible on configured port (default: 8010)
10. ‚úÖ Documentation created in service README

---

## Tasks / Subtasks

- [x] **Task 1: Create Service Directory Structure** (AC: 1)
  - [x] Create `services/sports-api/` directory
  - [x] Create `services/sports-api/src/` subdirectory
  - [x] Create `services/sports-api/tests/` subdirectory
  - [x] Create `__init__.py` files

- [x] **Task 2: Implement Base API Client** (AC: 2)
  - [x] Create `src/api_client.py` with `APISportsClient` class
  - [x] Implement `__aenter__` and `__aexit__` for async context manager
  - [x] Configure aiohttp ClientSession with connection pooling (Context7 KB pattern)
  - [x] Configure TCPConnector (limit=30, limit_per_host=10)
  - [x] Configure ClientTimeout (total=30, connect=10)
  - [x] Implement `_get_headers()` method for API authentication
  - [x] Implement `_request()` method with retry logic (3 attempts, exponential backoff)
  - [x] Add graceful shutdown with `await asyncio.sleep(0)`

- [x] **Task 3: Create Service Entry Point** (AC: 7, 9)
  - [x] Create `src/main.py` with `SportsAPIService` class
  - [x] Implement service initialization with configuration loading
  - [x] Implement `start()` method for component initialization
  - [x] Implement `stop()` method for cleanup
  - [x] Create aiohttp web application
  - [x] Configure correlation middleware
  - [x] Add web server runner on configured port (8010)

- [x] **Task 4: Implement Health Check** (AC: 5)
  - [x] Create `src/health_check.py` with `HealthCheckHandler` class
  - [x] Implement `handle()` method returning JSON health status
  - [x] Add service metadata (version, timestamp, status)
  - [x] Add component health checks placeholders
  - [x] Register `/health` route in main application

- [x] **Task 5: Configure Environment Variables** (AC: 4)
  - [x] Create `infrastructure/env.sports.template`
  - [x] Add API_SPORTS_KEY configuration
  - [x] Add service configuration (port, enabled flags)
  - [x] Add rate limiting configuration
  - [x] Add caching configuration
  - [x] Add InfluxDB configuration
  - [x] Add logging configuration

- [x] **Task 6: Docker Configuration** (AC: 3, 7)
  - [x] Create `services/sports-api/Dockerfile` (production)
  - [x] Create `services/sports-api/Dockerfile.dev` (development)
  - [x] Create `services/sports-api/requirements.txt`
  - [x] Add to `docker-compose.yml`:
    - [x] Service definition
    - [x] Port mapping (8015:8015) - changed from 8010 due to port conflict
    - [x] Environment variables
    - [x] Network configuration
    - [x] Dependency on influxdb
    - [x] Health check command
  - [x] Test service builds successfully
  - [x] Test service starts in Docker Compose

- [x] **Task 7: Shared Logging Integration** (AC: 6)
  - [x] Import shared logging_config
  - [x] Call `setup_logging("sports-api")`
  - [x] Add correlation middleware to application
  - [x] Test structured logging output
  - [x] Verify correlation IDs in logs

- [x] **Task 8: Unit Tests** (AC: 8)
  - [x] Create `tests/test_api_client.py`
  - [x] Test ClientSession initialization
  - [x] Test header generation
  - [x] Test retry logic (mock failures)
  - [x] Test timeout configuration
  - [x] Test graceful shutdown
  - [x] Create `tests/test_main.py`
  - [x] Test service initialization
  - [x] Test health check endpoint
  - [x] Verify 90%+ coverage

- [x] **Task 9: Documentation** (AC: 10)
  - [x] Create `services/sports-api/README.md`
  - [x] Document service purpose
  - [x] Document configuration options
  - [x] Document local development setup
  - [x] Document testing commands
  - [x] Document deployment process

---

## Dev Notes

### Relevant Source Tree Information

**Service Location:** `services/sports-api/`

**Directory Structure Pattern** (from `docs/architecture/source-tree.md`):
```
services/sports-api/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                      # Service entry point
‚îÇ   ‚îú‚îÄ‚îÄ api_client.py                # Base API client
‚îÇ   ‚îú‚îÄ‚îÄ health_check.py              # Health check handler
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_api_client.py
‚îÇ   ‚îî‚îÄ‚îÄ test_main.py
‚îú‚îÄ‚îÄ Dockerfile                       # Production
‚îú‚îÄ‚îÄ Dockerfile.dev                   # Development
‚îú‚îÄ‚îÄ requirements.txt                 # Dependencies
‚îî‚îÄ‚îÄ README.md                        # Documentation
```

### Architecture References

**Technology Stack** (from `docs/architecture/tech-stack.md`):
- Python 3.11
- aiohttp 3.9.1 (async HTTP client/server)
- Docker 24+

**Base API Client Pattern** (from `docs/architecture/sports-api-integration.md`, Section 4.1):

```python
class APISportsClient:
    def __init__(self, api_key: str, base_url: str):
        self.api_key = api_key
        self.base_url = base_url
        self.session: Optional[aiohttp.ClientSession] = None
        
    async def __aenter__(self):
        timeout = aiohttp.ClientTimeout(total=30, connect=10)
        connector = aiohttp.TCPConnector(limit=30, limit_per_host=10)
        self.session = aiohttp.ClientSession(
            connector=connector,
            timeout=timeout,
            headers=self._get_headers()
        )
        return self
    
    async def __aexit__(self, exc_type, exc_val, exc_tb):
        if self.session:
            await self.session.close()
            await asyncio.sleep(0)  # Graceful shutdown (Context7 KB)
    
    def _get_headers(self) -> Dict[str, str]:
        return {
            'x-rapidapi-key': self.api_key,
            'x-rapidapi-host': 'api-sports.io',
            'User-Agent': 'HA-Ingestor-Sports/1.0'
        }
    
    async def _request(
        self, 
        method: str, 
        endpoint: str, 
        **kwargs
    ) -> Dict[str, Any]:
        """Execute request with retry logic"""
        for attempt in range(3):
            try:
                async with self.session.request(
                    method, 
                    f"{self.base_url}{endpoint}", 
                    **kwargs
                ) as response:
                    response.raise_for_status()
                    return await response.json()
            except aiohttp.ClientError as e:
                if attempt == 2:
                    raise
                await asyncio.sleep(0.1 * (attempt + 1))
```

**Context7 KB Best Practices** (from `docs/kb/context7-cache/aiohttp-client-patterns.md`):
- Use TCPConnector for connection pooling
- Set reasonable limits (limit=30, limit_per_host=10)
- Configure timeouts (total=30s, connect=10s)
- Implement graceful shutdown with `await asyncio.sleep(0)`
- Use retry middleware with exponential backoff

**Shared Logging Pattern** (from existing services):
```python
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '../../shared'))

from shared.logging_config import setup_logging
from shared.correlation_middleware import create_correlation_middleware

logger = setup_logging("sports-api")
```

**Main Service Pattern** (from `services/weather-api/src/main.py`):
```python
async def main():
    service = SportsAPIService()
    await service.start()
    
    app = service.create_app()
    runner = web.AppRunner(app)
    await runner.setup()
    
    port = int(os.getenv('SPORTS_API_PORT', '8010'))
    site = web.TCPSite(runner, '0.0.0.0', port)
    await site.start()
    
    logger.info(f"Sports API Service started on port {port}")
    
    try:
        await asyncio.Future()  # Run forever
    except KeyboardInterrupt:
        logger.info("Shutting down...")
    finally:
        await service.stop()
        await runner.cleanup()

if __name__ == "__main__":
    asyncio.run(main())
```

**Docker Compose Pattern** (from architecture document):
```yaml
services:
  sports-api:
    build:
      context: ./services/sports-api
      dockerfile: Dockerfile.dev
    container_name: ha-sports-api
    ports:
      - "8010:8010"
    env_file:
      - infrastructure/env.sports.template
    environment:
      - API_SPORTS_KEY=${API_SPORTS_KEY}
      - SPORTS_API_PORT=8010
    networks:
      - homeiq-network
    depends_on:
      - influxdb
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

**Dependencies (requirements.txt)**:
```
aiohttp==3.9.1
python-dotenv==1.0.0
pydantic==2.5.0
influxdb-client-3>=3.0.0
pytest==7.4.3
pytest-asyncio==0.21.1
pytest-cov==4.1.0
```

### Important Implementation Notes

1. **Context Manager Pattern**: Use async context managers (`async with`) for ClientSession lifecycle
2. **Connection Pooling**: TCPConnector manages connection pool automatically
3. **Graceful Shutdown**: Always call `await asyncio.sleep(0)` after session.close() (Context7 KB)
4. **Retry Logic**: 3 attempts with exponential backoff (0.1s, 0.2s, 0.3s)
5. **Correlation IDs**: Use shared middleware for request tracking
6. **Error Handling**: Catch aiohttp.ClientError for network issues

### Testing

**Test Framework**: pytest with pytest-asyncio  
**Coverage Target**: 90%+  
**Test Location**: `services/sports-api/tests/`

**Test Standards** (from `docs/architecture/testing-strategy.md`):
- Use pytest-asyncio for async tests
- Mock external API calls with unittest.mock
- Test success and failure scenarios
- Test retry logic with multiple failures
- Verify logging output
- Check health endpoint returns correct JSON

**Example Test Pattern**:
```python
import pytest
from unittest.mock import AsyncMock, patch

@pytest.mark.asyncio
async def test_api_client_initialization():
    """Test API client initializes correctly"""
    client = APISportsClient('test-key', 'https://api-sports.io')
    
    async with client:
        assert client.session is not None
        assert client.session.timeout.total == 30
    
    # Session should be closed after context exit
    assert client.session.closed

@pytest.mark.asyncio
async def test_api_client_retry_logic():
    """Test retry logic on failures"""
    client = APISportsClient('test-key', 'https://api-sports.io')
    
    with patch('aiohttp.ClientSession.request') as mock_request:
        # Simulate 2 failures then success
        mock_request.side_effect = [
            aiohttp.ClientError("Connection failed"),
            aiohttp.ClientError("Connection failed"),
            AsyncMock(status=200, json=AsyncMock(return_value={'data': 'ok'}))
        ]
        
        async with client:
            result = await client._request('GET', '/test')
            assert result == {'data': 'ok'}
            assert mock_request.call_count == 3
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-11 | 1.0 | Story created from epic 10 | Sarah (PO) |
| 2025-10-11 | 1.1 | Story implemented - all tasks complete | James (Dev) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 - James (Dev Agent)
Implementation Date: October 11, 2025

### Debug Log References
No debug issues encountered. All implementation completed successfully on first attempt.

### Completion Notes
- ‚úÖ All 9 tasks completed successfully
- ‚úÖ Service foundation fully implemented with Context7 KB patterns
- ‚úÖ Comprehensive unit tests created (14 test cases)
- ‚úÖ Docker configuration complete
- ‚úÖ Documentation comprehensive
- ‚ö†Ô∏è Port changed from 8010 to 8015 due to conflict with carbon-intensity service
- ‚úÖ All acceptance criteria met
- üìù Ready for Story 10.2 (NFL Client Implementation)

Implementation highlights:
- Base API client follows Context7 KB best practices (connection pooling, retry logic, graceful shutdown)
- Service structured for easy extension in future stories
- Health check endpoint operational
- Placeholder components for future stories (NFL/NHL clients, cache, InfluxDB writer)

### File List

**Created Files:**
- `services/sports-api/src/__init__.py`
- `services/sports-api/src/api_client.py`
- `services/sports-api/src/main.py`
- `services/sports-api/src/health_check.py`
- `services/sports-api/tests/__init__.py`
- `services/sports-api/tests/test_api_client.py`
- `services/sports-api/tests/test_main.py`
- `services/sports-api/Dockerfile`
- `services/sports-api/Dockerfile.dev`
- `services/sports-api/requirements.txt`
- `services/sports-api/README.md`
- `infrastructure/env.sports.template`

**Modified Files:**
- `docker-compose.yml` (added sports-api service)
- `docs/stories/10.1-sports-api-service-foundation.md` (task checkboxes, status, Dev Agent Record)

---

## QA Results
*To be populated by QA agent*

