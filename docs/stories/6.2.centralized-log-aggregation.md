# Story 6.2: Centralized Log Aggregation

## Status
Draft

## Story

**As a** system administrator and operations team,  
**I want** all service logs to be aggregated into a centralized system with search and filtering capabilities,  
**so that** I can efficiently search, analyze, and troubleshoot issues across all services from a single interface.

## Acceptance Criteria

1. **AC1: Centralized Log Collection** - All service logs are collected and stored in a centralized system accessible from a single interface
2. **AC2: Log Search and Filtering** - Ability to search logs by service, time range, log level, correlation ID, and custom fields
3. **AC3: Real-time Log Streaming** - Real-time log streaming and monitoring capabilities for immediate issue detection
4. **AC4: Log Retention Policies** - Configurable log retention policies with automatic cleanup and archival
5. **AC5: Log Storage Management** - Efficient log storage with compression, indexing, and storage optimization
6. **AC6: Log Analysis Dashboard** - Web-based dashboard for log analysis, visualization, and reporting
7. **AC7: Log Export and Backup** - Ability to export logs and create backups for compliance and analysis
8. **AC8: Log Aggregation Monitoring** - Monitoring and alerting for log aggregation system health and performance

## Tasks / Subtasks

- [x] **Task 1: Log Aggregation Infrastructure** (AC: 1)
  - [x] Set up ELK stack (Elasticsearch, Logstash, Kibana) or similar solution
  - [x] Configure Docker services for log aggregation
  - [x] Set up log collection agents for each service
  - [x] Configure log routing and parsing rules

- [x] **Task 2: Log Collection Configuration** (AC: 1, 3)
  - [x] Configure Docker log drivers for centralized collection
  - [x] Set up log streaming and real-time monitoring
  - [x] Configure log parsing and field extraction
  - [x] Implement log buffering and batching for performance

- [x] **Task 3: Search and Filtering Implementation** (AC: 2)
  - [x] Implement full-text search capabilities
  - [x] Add filtering by service, time range, log level
  - [x] Implement correlation ID search and tracing
  - [x] Add custom field filtering and advanced queries

- [x] **Task 4: Log Retention and Storage** (AC: 4, 5)
  - [x] Implement configurable retention policies
  - [x] Set up automatic log cleanup and archival
  - [x] Configure log compression and storage optimization
  - [x] Implement log rotation and storage monitoring

- [x] **Task 5: Log Analysis Dashboard** (AC: 6)
  - [x] Create web-based log analysis interface
  - [x] Implement log visualization and charts
  - [x] Add log statistics and reporting features
  - [x] Create custom dashboards for different user roles

- [x] **Task 6: Export and Backup System** (AC: 7)
  - [x] Implement log export functionality (CSV, JSON, PDF)
  - [x] Set up automated log backup procedures
  - [x] Create log archival and retrieval system
  - [x] Implement compliance and audit logging

- [x] **Task 7: Monitoring and Alerting** (AC: 8)
  - [x] Monitor log aggregation system health
  - [x] Set up alerts for log collection failures
  - [x] Monitor storage usage and performance
  - [x] Create log aggregation performance metrics

## Dev Notes

### Current State
**Foundation**: Docker Compose infrastructure, basic logging framework, Docker logging drivers

**Target Architecture**: Services → Structured Logs → ELK Stack → Centralized Storage → Analysis Dashboard

### Implementation Strategy
1. **Infrastructure Setup**: ELK stack configuration and Docker services
2. **Search and Analysis**: Search capabilities and log analysis dashboard  
3. **Storage Management**: Retention policies and backup functionality

### Technology Choice
**Implemented**: Log Aggregator service with structured JSON logging for efficient log collection and analysis

### Source Tree Information

**New Files to Create:**
- `services/log-aggregator/` - Log aggregation service
- `scripts/log-aggregation/` - Log aggregation scripts

**Files to Modify:**
- `docker-compose.yml` - Add log aggregation services
- `docker-compose.dev.yml` - Development log aggregation
- `docker-compose.prod.yml` - Production log aggregation
- `infrastructure/env.example` - Log aggregation environment variables

### Docker Configuration

**Docker Compose Addition:**
```yaml
services:
  log-aggregator:
    build: ./services/log-aggregator
    ports:
      - "8007:8007"
    volumes:
      - /var/log/homeiq:/var/log/homeiq:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - LOG_LEVEL=INFO
    restart: unless-stopped
```

**Log Driver Configuration:**
```yaml
services:
  websocket-ingestion:
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
        labels: "service=websocket-ingestion"
```

### Configuration Requirements
**Environment Variables**: LOG_AGGREGATION_ENABLED, ELASTICSEARCH_URL, KIBANA_URL, LOG_RETENTION_DAYS

### Key Features
- Full-text search across all log fields
- Service-specific search and time range filtering
- Correlation ID tracing and custom field filtering
- Log volume visualization and error rate trends

### Performance & Security
- Asynchronous log collection with batching
- Elasticsearch optimization and retention policies
- Secure transmission and access control
- Data sanitization for sensitive information

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-04 | 1.0 | Initial story creation for centralized log aggregation | BMad Master |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used

*To be filled by dev agent*

### Debug Log References

*To be filled by dev agent*

### Completion Notes List

*To be filled by dev agent*

### File List

*To be filled by dev agent*

## QA Results

*Results from QA Agent QA review of the completed centralized log aggregation implementation*
